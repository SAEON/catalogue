FROM node:17.7.1

ARG ALLOWED_ORIGINS
ENV ALLOWED_ORIGINS=$ALLOWED_ORIGINS

ARG API_ADDRESS
ENV API_ADDRESS=$API_ADDRESS

ARG APP_KEY
ENV APP_KEY=$APP_KEY

ARG ODP_CLIENT_SECRET
ENV ODP_CLIENT_SECRET=$ODP_CLIENT_SECRET

ARG ODP_FILTER_PATH
ENV ODP_FILTER_PATH=$ODP_FILTER_PATH

ARG NODE_ENV
ENV NODE_ENV=$NODE_ENV

ARG CURATOR_CONTACT
ENV CURATOR_CONTACT=$CURATOR_CONTACT

ARG LOG_QUERY_DETAILS
ENV LOG_QUERY_DETAILS=$LOG_QUERY_DETAILS

ARG TECHNICAL_CONTACT
ENV TECHNICAL_CONTACT=$TECHNICAL_CONTACT

ARG DEPLOYMENT_ENV
ENV DEPLOYMENT_ENV=$DEPLOYMENT_ENV

ARG DOCKER_NETWORK
ENV DOCKER_NETWORK=$DOCKER_NETWORK

ARG DEFAULT_SYSADMIN_EMAIL_ADDRESSES
ENV DEFAULT_SYSADMIN_EMAIL_ADDRESSES=$DEFAULT_SYSADMIN_EMAIL_ADDRESSES

ARG ELASTICSEARCH_ADDRESS
ENV ELASTICSEARCH_ADDRESS=$ELASTICSEARCH_ADDRESS

ARG DEFAULT_ADMIN_EMAIL_ADDRESSES
ENV DEFAULT_ADMIN_EMAIL_ADDRESSES=$DEFAULT_ADMIN_EMAIL_ADDRESSES

ARG MONGO_DB
ENV MONGO_DB=$MONGO_DB

ARG MONGO_DB_ADDRESS
ENV MONGO_DB_ADDRESS=$MONGO_DB_ADDRESS

ARG MONGO_DB_PASSWORD
ENV MONGO_DB_PASSWORD=$MONGO_DB_PASSWORD

ARG MONGO_DB_USERNAME
ENV MONGO_DB_USERNAME=$MONGO_DB_USERNAME

ARG ODP_ADDRESS
ENV ODP_ADDRESS=$ODP_ADDRESS

ARG POSTGIS_HOST
ENV POSTGIS_HOST=$POSTGIS_HOST

ARG POSTGIS_PASSWORD
ENV POSTGIS_PASSWORD=$POSTGIS_PASSWORD

ARG POSTGIS_DB
ENV POSTGIS_DB=$POSTGIS_DB

ARG POSTGIS_PORT
ENV POSTGIS_PORT=$POSTGIS_PORT

ARG POSTGIS_USERNAME
ENV POSTGIS_USERNAME=$POSTGIS_USERNAME

ARG ODP_SSO_CLIENT_ID
ENV ODP_SSO_CLIENT_ID=$ODP_SSO_CLIENT_ID

ARG ODP_SSO_CLIENT_SECRET
ENV ODP_SSO_CLIENT_SECRET=$ODP_SSO_CLIENT_SECRET

ARG ODP_SSO_CLIENT_SCOPES
ENV ODP_SSO_CLIENT_SCOPES=$ODP_SSO_CLIENT_SCOPES

ARG DOCKER_DATA_VOLUME
ENV DOCKER_DATA_VOLUME=$DOCKER_DATA_VOLUME

ARG DOCKER_TMP_VOLUME
ENV DOCKER_TMP_VOLUME=$DOCKER_TMP_VOLUME

ARG POSTGIS_IMAGE_NAME
ENV POSTGIS_IMAGE_NAME=$POSTGIS_IMAGE_NAME

ARG POSTGIS_CONTAINER_NAME
ENV POSTGIS_CONTAINER_NAME=$POSTGIS_CONTAINER_NAME

ARG NODE_TLS_REJECT_UNAUTHORIZED
ENV NODE_TLS_REJECT_UNAUTHORIZED=$NODE_TLS_REJECT_UNAUTHORIZED

ARG ODP_AUTH_SCOPES
ENV ODP_AUTH_SCOPES=$ODP_AUTH_SCOPES

ARG GDAL_DOCKER_IMAGE
ENV GDAL_DOCKER_IMAGE=$GDAL_DOCKER_IMAGE

ARG POSTGIS_USERNAME_PUBLIC
ENV POSTGIS_USERNAME_PUBLIC=$POSTGIS_USERNAME_PUBLIC

ARG POSTGIS_PASSWORD_PUBLIC
ENV POSTGIS_PASSWORD_PUBLIC=$POSTGIS_PASSWORD_PUBLIC

ARG HOSTNAME
ENV HOSTNAME=$HOSTNAME

ARG SAEON_ODP_INTEGRATION_SCHEDULE
ENV SAEON_ODP_INTEGRATION_SCHEDULE=$SAEON_ODP_INTEGRATION_SCHEDULE

ARG TZ
ENV TZ=$TZ

WORKDIR /app

# Allow access to host's Docker engine
COPY --from=docker:latest /usr/local/bin/docker /usr/local/bin/

# Copy code
COPY . .

# Install deps
RUN npm ci --only=production

# Setup the CLI and API executables
ENV PATH="bin:$PATH"
RUN chmod +x bin/sdp
RUN chmod +x bin/api

# Expose HTTP interface
EXPOSE 3000

CMD \
  SAEON_ODP_INTEGRATION_SCHEDULE=$SAEON_ODP_INTEGRATION_SCHEDULE \
  ODP_AUTH_SCOPES=$ODP_AUTH_SCOPES \
  LOG_QUERY_DETAILS=$LOG_QUERY_DETAILS \
  GDAL_DOCKER_IMAGE=$GDAL_DOCKER_IMAGE \
  POSTGIS_USERNAME_PUBLIC=$POSTGIS_USERNAME_PUBLIC \
  POSTGIS_PASSWORD_PUBLIC=$POSTGIS_PASSWORD_PUBLIC \
  DEFAULT_SYSADMIN_EMAIL_ADDRESSES=$DEFAULT_SYSADMIN_EMAIL_ADDRESSES \
  HOSTNAME=$HOSTNAME \
  POSTGIS_CONTAINER_NAME=$POSTGIS_CONTAINER_NAME \
  DOCKER_DATA_VOLUME=$DOCKER_DATA_VOLUME \
  DOCKER_TMP_VOLUME=$DOCKER_TMP_VOLUME \
  POSTGIS_IMAGE_NAME=$POSTGIS_IMAGE_NAME \
  TECHNICAL_CONTACT=$TECHNICAL_CONTACT \
  ODP_SSO_CLIENT_ID=$ODP_SSO_CLIENT_ID \
  ODP_SSO_CLIENT_SECRET=$ODP_SSO_CLIENT_SECRET \
  ODP_SSO_CLIENT_SCOPES=$ODP_SSO_CLIENT_SCOPES \
  DEFAULT_ADMIN_EMAIL_ADDRESSES=$DEFAULT_ADMIN_EMAIL_ADDRESSES \
  ALLOWED_ORIGINS=$ALLOWED_ORIGINS \
  API_ADDRESS=$API_ADDRESS \
  NODE_ENV=$NODE_ENV \
  ODP_CLIENT_SECRET=$ODP_CLIENT_SECRET \
  ODP_FILTER_PATH=$ODP_FILTER_PATH \
  CURATOR_CONTACT=$CURATOR_CONTACT \
  DEPLOYMENT_ENV=$DEPLOYMENT_ENV \
  DOCKER_NETWORK=$DOCKER_NETWORK \
  ELASTICSEARCH_ADDRESS=$ELASTICSEARCH_ADDRESS \
  MONGO_DB=$MONGO_DB \
  MONGO_DB_ADDRESS=$MONGO_DB_ADDRESS \
  MONGO_DB_PASSWORD=$MONGO_DB_PASSWORD \
  MONGO_DB_USERNAME=$MONGO_DB_USERNAME \
  ODP_ADDRESS=$ODP_ADDRESS \
  POSTGIS_DB=$POSTGIS_DB \
  POSTGIS_HOST=$POSTGIS_HOST \
  POSTGIS_PASSWORD=$POSTGIS_PASSWORD \
  POSTGIS_PORT=$POSTGIS_PORT \
  POSTGIS_USERNAME=$POSTGIS_USERNAME \
  NODE_TLS_REJECT_UNAUTHORIZED=$NODE_TLS_REJECT_UNAUTHORIZED \
  TZ=$TZ \
  api