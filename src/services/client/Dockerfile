ARG CATALOGUE_API_ADDRESS
ENV CATALOGUE_API_ADDRESS=$CATALOGUE_API_ADDRESS

ARG GQL_PROVIDER
ENV GQL_PROVIDER=$GQL_PROVIDER

ARG GQL_SUBSCRIPTIONS_PROVIDER
ENV GQL_SUBSCRIPTIONS_PROVIDER=$GQL_SUBSCRIPTIONS_PROVIDER

ARG REDIRECT_URL
ENV REDIRECT_URL=$REDIRECT_URL

ARG CLIENT_HOST_ADDRESS
ENV CLIENT_HOST_ADDRESS=$CLIENT_HOST_ADDRESS

ARG DEPLOYMENT_ENV
ENV DEPLOYMENT_ENV=$DEPLOYMENT_ENV

ARG DEFAULT_NOTICES
ENV DEFAULT_NOTICES=$DEFAULT_NOTICES

ARG LATEST_COMMIT
ENV LATEST_COMMIT=$LATEST_COMMIT

# Build client
FROM node:14.13 as build
WORKDIR /app
COPY . .
RUN npm ci --only=production
RUN \
  CATALOGUE_API_ADDRESS=$CATALOGUE_API_ADDRESS \
  GQL_PROVIDER=$GQL_PROVIDER \
  GQL_SUBSCRIPTIONS_PROVIDER=$GQL_SUBSCRIPTIONS_PROVIDER \
  REDIRECT_URL=$REDIRECT_URL \
  CLIENT_HOST_ADDRESS=$CLIENT_HOST_ADDRESS \
  DEPLOYMENT_ENV=$DEPLOYMENT_ENV \
  DEFAULT_NOTICES=$DEFAULT_NOTICES \
  LATEST_COMMIT=$LATEST_COMMIT \
  npm run build

# Serve static files
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx/nginx.conf /etc/nginx/nginx.conf
COPY nginx/localhost.conf /etc/nginx/conf.d/default.conf
EXPOSE 80