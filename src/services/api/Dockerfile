FROM node:15.14

ARG CATALOGUE_API_ALLOWED_ORIGINS
ENV CATALOGUE_API_ALLOWED_ORIGINS=$CATALOGUE_API_ALLOWED_ORIGINS

ARG CATALOGUE_API_GOOGLE_CLIENT_ID
ENV CATALOGUE_API_GOOGLE_CLIENT_ID=$CATALOGUE_API_GOOGLE_CLIENT_ID

ARG CATALOGUE_API_GOOGLE_CLIENT_SECRET
ENV CATALOGUE_API_GOOGLE_CLIENT_SECRET=$CATALOGUE_API_GOOGLE_CLIENT_SECRET

ARG CATALOGUE_API_ADDRESS
ENV CATALOGUE_API_ADDRESS=$CATALOGUE_API_ADDRESS

ARG CATALOGUE_API_KEY
ENV CATALOGUE_API_KEY=$CATALOGUE_API_KEY

ARG CATALOGUE_API_GOOGLE_OAUTH_REDIRECT_ADDRESS
ENV CATALOGUE_API_GOOGLE_OAUTH_REDIRECT_ADDRESS=$CATALOGUE_API_GOOGLE_OAUTH_REDIRECT_ADDRESS

ARG CATALOGUE_API_ODP_CLIENT_SECRET
ENV CATALOGUE_API_ODP_CLIENT_SECRET=$CATALOGUE_API_ODP_CLIENT_SECRET

ARG CATALOGUE_API_ODP_FILTER_PATH
ENV CATALOGUE_API_ODP_FILTER_PATH=$CATALOGUE_API_ODP_FILTER_PATH

ARG CATALOGUE_API_NODE_ENV
ENV CATALOGUE_API_NODE_ENV=$CATALOGUE_API_NODE_ENV

ARG CATALOGUE_CURATOR_CONTACT
ENV CATALOGUE_CURATOR_CONTACT=$CATALOGUE_CURATOR_CONTACT

ARG CATALOGUE_TECHNICAL_CONTACT
ENV CATALOGUE_TECHNICAL_CONTACT=$CATALOGUE_TECHNICAL_CONTACT

ARG CATALOGUE_DEPLOYMENT_ENV
ENV CATALOGUE_DEPLOYMENT_ENV=$CATALOGUE_DEPLOYMENT_ENV

ARG CATALOGUE_DOCKER_NETWORK
ENV CATALOGUE_DOCKER_NETWORK=$CATALOGUE_DOCKER_NETWORK

ARG CATALOGUE_LATEST_COMMIT
ENV CATALOGUE_LATEST_COMMIT=$CATALOGUE_LATEST_COMMIT

ARG CATALOGUE_API_PROXY_ADDRESS
ENV CATALOGUE_API_PROXY_ADDRESS=$CATALOGUE_API_PROXY_ADDRESS

ARG ELASTICSEARCH_ADDRESS
ENV ELASTICSEARCH_ADDRESS=$ELASTICSEARCH_ADDRESS

ARG CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES
ENV CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES=$CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES

ARG MONGO_DB_ADDRESS
ENV MONGO_DB_ADDRESS=$MONGO_DB_ADDRESS

ARG MONGO_DB_PASSWORD
ENV MONGO_DB_PASSWORD=$MONGO_DB_PASSWORD

ARG MONGO_DB_USERNAME
ENV MONGO_DB_USERNAME=$MONGO_DB_USERNAME

ARG ODP_ADDRESS
ENV ODP_ADDRESS=$ODP_ADDRESS

ARG POSTGIS_HOST
ENV POSTGIS_HOST=$POSTGIS_HOST

ARG POSTGIS_PASSWORD
ENV POSTGIS_PASSWORD=$POSTGIS_PASSWORD

ARG POSTGIS_DB
ENV POSTGIS_DB=$POSTGIS_DB

ARG POSTGIS_PORT
ENV POSTGIS_PORT=$POSTGIS_PORT

ARG POSTGIS_USERNAME
ENV POSTGIS_USERNAME=$POSTGIS_USERNAME

ARG CATALOGUE_API_INTERNAL_ADDRESS
ENV CATALOGUE_API_INTERNAL_ADDRESS=$CATALOGUE_API_INTERNAL_ADDRESS

ARG CATALOGUE_API_ODP_USER_AUTH_CLIENT_ID
ENV CATALOGUE_API_ODP_USER_AUTH_CLIENT_ID=$CATALOGUE_API_ODP_USER_AUTH_CLIENT_ID

ARG CATALOGUE_API_ODP_USER_AUTH_CLIENT_SECRET
ENV CATALOGUE_API_ODP_USER_AUTH_CLIENT_SECRET=$CATALOGUE_API_ODP_USER_AUTH_CLIENT_SECRET

ARG CATALOGUE_API_ODP_USER_AUTH_CLIENT_SCOPES
ENV CATALOGUE_API_ODP_USER_AUTH_CLIENT_SCOPES=$CATALOGUE_API_ODP_USER_AUTH_CLIENT_SCOPES

ARG CATALOGUE_API_ODP_USER_AUTH_CLIENT_REDIRECT_ADDRESS
ENV CATALOGUE_API_ODP_USER_AUTH_CLIENT_REDIRECT_ADDRESS=$CATALOGUE_API_ODP_USER_AUTH_CLIENT_REDIRECT_ADDRESS

ARG CATALOGUE_API_TWITTER_CLIENT_ID
ENV CATALOGUE_API_TWITTER_CLIENT_ID=$CATALOGUE_API_TWITTER_CLIENT_ID

ARG CATALOGUE_API_TWITTER_CLIENT_SECRET
ENV CATALOGUE_API_TWITTER_CLIENT_SECRET=$CATALOGUE_API_TWITTER_CLIENT_SECRET

ARG CATALOGUE_API_TWITTER_OAUTH_REDIRECT_ADDRESS
ENV CATALOGUE_API_TWITTER_OAUTH_REDIRECT_ADDRESS=$CATALOGUE_API_TWITTER_OAUTH_REDIRECT_ADDRESS

ARG CATALOGUE_DOCKER_DATA_VOLUME
ENV CATALOGUE_DOCKER_DATA_VOLUME=$CATALOGUE_DOCKER_DATA_VOLUME

ARG CATALOGUE_DOCKER_TMP_VOLUME
ENV CATALOGUE_DOCKER_TMP_VOLUME=$CATALOGUE_DOCKER_TMP_VOLUME

ARG POSTGIS_IMAGE_NAME
ENV POSTGIS_IMAGE_NAME=$POSTGIS_IMAGE_NAME

ARG POSTGIS_CONTAINER_NAME
ENV POSTGIS_CONTAINER_NAME=$POSTGIS_CONTAINER_NAME

ARG NODE_TLS_REJECT_UNAUTHORIZED
ENV NODE_TLS_REJECT_UNAUTHORIZED=$NODE_TLS_REJECT_UNAUTHORIZED

ARG GDAL_DOCKER_IMAGE
ENV GDAL_DOCKER_IMAGE=$GDAL_DOCKER_IMAGE

WORKDIR /app
COPY --from=docker:19.03 /usr/local/bin/docker /usr/local/bin/
COPY . .
RUN npm ci --only=production
EXPOSE 3000 4000

CMD \
  GDAL_DOCKER_IMAGE=$GDAL_DOCKER_IMAGE \
  POSTGIS_CONTAINER_NAME=$POSTGIS_CONTAINER_NAME \
  CATALOGUE_DOCKER_DATA_VOLUME=$CATALOGUE_DOCKER_DATA_VOLUME \
  CATALOGUE_DOCKER_TMP_VOLUME=$CATALOGUE_DOCKER_TMP_VOLUME \
  POSTGIS_IMAGE_NAME=$POSTGIS_IMAGE_NAME \
  CATALOGUE_API_TWITTER_CLIENT_ID=$CATALOGUE_API_TWITTER_CLIENT_ID \
  CATALOGUE_API_TWITTER_CLIENT_SECRET=$CATALOGUE_API_TWITTER_CLIENT_SECRET \
  CATALOGUE_API_TWITTER_OAUTH_REDIRECT_ADDRESS=$CATALOGUE_API_TWITTER_OAUTH_REDIRECT_ADDRESS \
  CATALOGUE_TECHNICAL_CONTACT=$CATALOGUE_TECHNICAL_CONTACT \
  CATALOGUE_API_ODP_USER_AUTH_CLIENT_ID=$CATALOGUE_API_ODP_USER_AUTH_CLIENT_ID \
  CATALOGUE_API_ODP_USER_AUTH_CLIENT_SECRET=$CATALOGUE_API_ODP_USER_AUTH_CLIENT_SECRET \
  CATALOGUE_API_ODP_USER_AUTH_CLIENT_SCOPES=$CATALOGUE_API_ODP_USER_AUTH_CLIENT_SCOPES \
  CATALOGUE_API_ODP_USER_AUTH_CLIENT_REDIRECT_ADDRESS=$CATALOGUE_API_ODP_USER_AUTH_CLIENT_REDIRECT_ADDRESS \
  CATALOGUE_API_INTERNAL_ADDRESS=$CATALOGUE_API_INTERNAL_ADDRESS \
  CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES=$CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES \
  CATALOGUE_API_ALLOWED_ORIGINS=$CATALOGUE_API_ALLOWED_ORIGINS \
  CATALOGUE_API_GOOGLE_CLIENT_ID=$CATALOGUE_API_GOOGLE_CLIENT_ID \
  CATALOGUE_API_GOOGLE_CLIENT_SECRET=$CATALOGUE_API_GOOGLE_CLIENT_SECRET \
  CATALOGUE_API_ADDRESS=$CATALOGUE_API_ADDRESS \
  CATALOGUE_API_NODE_ENV=$CATALOGUE_API_NODE_ENV \
  CATALOGUE_API_GOOGLE_OAUTH_REDIRECT_ADDRESS=$CATALOGUE_API_GOOGLE_OAUTH_REDIRECT_ADDRESS \
  CATALOGUE_API_ODP_CLIENT_SECRET=$CATALOGUE_API_ODP_CLIENT_SECRET \
  CATALOGUE_API_ODP_FILTER_PATH=$CATALOGUE_API_ODP_FILTER_PATH \
  CATALOGUE_CURATOR_CONTACT=$CATALOGUE_CURATOR_CONTACT \
  CATALOGUE_DEPLOYMENT_ENV=$CATALOGUE_DEPLOYMENT_ENV \
  CATALOGUE_DOCKER_NETWORK=$CATALOGUE_DOCKER_NETWORK \
  CATALOGUE_LATEST_COMMIT=$CATALOGUE_LATEST_COMMIT \
  CATALOGUE_API_PROXY_ADDRESS=$CATALOGUE_API_PROXY_ADDRESS \
  ELASTICSEARCH_ADDRESS=$ELASTICSEARCH_ADDRESS \
  MONGO_DB_ADDRESS=$MONGO_DB_ADDRESS \
  MONGO_DB_PASSWORD=$MONGO_DB_PASSWORD \
  MONGO_DB_USERNAME=$MONGO_DB_USERNAME \
  ODP_ADDRESS=$ODP_ADDRESS \
  POSTGIS_DB=$POSTGIS_DB \
  POSTGIS_HOST=$POSTGIS_HOST \
  POSTGIS_PASSWORD=$POSTGIS_PASSWORD \
  POSTGIS_PORT=$POSTGIS_PORT \
  POSTGIS_USERNAME=$POSTGIS_USERNAME \
  NODE_TLS_REJECT_UNAUTHORIZED=$NODE_TLS_REJECT_UNAUTHORIZED \
  npm run start:prod