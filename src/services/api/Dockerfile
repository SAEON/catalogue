FROM node:14.15

ARG MONGO_DB_ADDRESS
ENV MONGO_DB_ADDRESS=$MONGO_DB_ADDRESS

ARG MONGO_DB_USERNAME
ENV MONGO_DB_USERNAME=$MONGO_DB_USERNAME

ARG MONGO_DB_PASSWORD
ENV MONGO_DB_PASSWORD=$MONGO_DB_PASSWORD

ARG POSTGIS_HOST
ENV POSTGIS_HOST=$POSTGIS_HOST

ARG POSTGIS_PORT
ENV POSTGIS_PORT=$POSTGIS_PORT

ARG POSTGIS_USERNAME
ENV POSTGIS_USERNAME=$POSTGIS_USERNAME

ARG POSTGIS_PASSWORD
ENV POSTGIS_PASSWORD=$POSTGIS_PASSWORD

ARG CATALOGUE_API_ALLOWED_ORIGINS
ENV CATALOGUE_API_ALLOWED_ORIGINS=$CATALOGUE_API_ALLOWED_ORIGINS

ARG CATALOGUE_PROXY_ADDRESS
ENV CATALOGUE_PROXY_ADDRESS=$CATALOGUE_PROXY_ADDRESS

ARG CATALOGUE_API_GQL_ADDRESS
ENV CATALOGUE_API_GQL_ADDRESS=$CATALOGUE_API_GQL_ADDRESS

ARG ELASTICSEARCH_ADDRESS
ENV ELASTICSEARCH_ADDRESS=$ELASTICSEARCH_ADDRESS

ARG CATALOGUE_API_RESET_ELASTICSEARCH_TEMPLATE
ENV CATALOGUE_API_RESET_ELASTICSEARCH_TEMPLATE=$CATALOGUE_API_RESET_ELASTICSEARCH_TEMPLATE

ARG CATALOGUE_API_RESET_ELASTICSEARCH_INDEX
ENV CATALOGUE_API_RESET_ELASTICSEARCH_INDEX=$CATALOGUE_API_RESET_ELASTICSEARCH_INDEX

ARG CATALOGUE_LATEST_COMMIT
ENV CATALOGUE_LATEST_COMMIT=$CATALOGUE_LATEST_COMMIT

ARG CATALOGUE_DEPLOYMENT_ENV
ENV CATALOGUE_DEPLOYMENT_ENV=$CATALOGUE_DEPLOYMENT_ENV

ARG ODP_ADDRESS
ENV ODP_ADDRESS=$ODP_ADDRESS

ARG CATALOGUE_API_ODP_CLIENT_SECRET
ENV CATALOGUE_API_ODP_CLIENT_SECRET=$CATALOGUE_API_ODP_CLIENT_SECRET

ARG CATALOGUE_DOCKER_NETWORK
ENV CATALOGUE_DOCKER_NETWORK=$CATALOGUE_DOCKER_NETWORK

WORKDIR /app
COPY --from=docker:19.03 /usr/local/bin/docker /usr/local/bin/
COPY . .
RUN npm ci --only=production
EXPOSE 3000

CMD \
  CATALOGUE_DOCKER_NETWORK=$CATALOGUE_DOCKER_NETWORK \
  CATALOGUE_API_ODP_CLIENT_SECRET=$CATALOGUE_API_ODP_CLIENT_SECRET \
  MONGO_DB_ADDRESS=$MONGO_DB_ADDRESS \
  MONGO_DB_USERNAME=$MONGO_DB_USERNAME \
  MONGO_DB_PASSWORD=$MONGO_DB_PASSWORD \
  POSTGIS_HOST=$POSTGIS_HOST \
  POSTGIS_PORT=$POSTGIS_PORT \
  POSTGIS_USERNAME=$POSTGIS_USERNAME \
  POSTGIS_PASSWORD=$POSTGIS_PASSWORD \
  CATALOGUE_API_ALLOWED_ORIGINS=$CATALOGUE_API_ALLOWED_ORIGINS \
  CATALOGUE_PROXY_ADDRESS=$CATALOGUE_PROXY_ADDRESS \
  CATALOGUE_API_GQL_ADDRESS=$CATALOGUE_API_GQL_ADDRESS \
  ELASTICSEARCH_ADDRESS=$ELASTICSEARCH_ADDRESS \
  CATALOGUE_API_RESET_ELASTICSEARCH_TEMPLATE=$CATALOGUE_API_RESET_ELASTICSEARCH_TEMPLATE \
  CATALOGUE_API_RESET_ELASTICSEARCH_INDEX=$CATALOGUE_API_RESET_ELASTICSEARCH_INDEX \
  CATALOGUE_LATEST_COMMIT=$CATALOGUE_LATEST_COMMIT \
  CATALOGUE_DEPLOYMENT_ENV=$CATALOGUE_DEPLOYMENT_ENV \
  ODP_ADDRESS=$ODP_ADDRESS \
  npm run start:prod