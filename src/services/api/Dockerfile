FROM node:14.15

ARG CATALOGUE_API_ALLOWED_ORIGINS
ENV CATALOGUE_API_ALLOWED_ORIGINS=$CATALOGUE_API_ALLOWED_ORIGINS

ARG CATALOGUE_API_GOOGLE_CLIENT_ID
ENV CATALOGUE_API_GOOGLE_CLIENT_ID=$CATALOGUE_API_GOOGLE_CLIENT_ID

ARG CATALOGUE_API_GOOGLE_CLIENT_SECRET
ENV CATALOGUE_API_GOOGLE_CLIENT_SECRET=$CATALOGUE_API_GOOGLE_CLIENT_SECRET

ARG CATALOGUE_API_ADDRESS
ENV CATALOGUE_API_ADDRESS=$CATALOGUE_API_ADDRESS

ARG CATALOGUE_API_KEY
ENV CATALOGUE_API_KEY=$CATALOGUE_API_KEY

ARG CATALOGUE_API_OAUTH_REDIRECT_ADDRESS
ENV CATALOGUE_API_OAUTH_REDIRECT_ADDRESS=$CATALOGUE_API_OAUTH_REDIRECT_ADDRESS

ARG CATALOGUE_API_ODP_CLIENT_SECRET
ENV CATALOGUE_API_ODP_CLIENT_SECRET=$CATALOGUE_API_ODP_CLIENT_SECRET

ARG CATALOGUE_API_ODP_FILTER_PATH
ENV CATALOGUE_API_ODP_FILTER_PATH=$CATALOGUE_API_ODP_FILTER_PATH

ARG CATALOGUE_API_NODE_ENV
ENV CATALOGUE_API_NODE_ENV=$CATALOGUE_API_NODE_ENV

ARG CATALOGUE_CURATOR_CONTACT
ENV CATALOGUE_CURATOR_CONTACT=$CATALOGUE_CURATOR_CONTACT

ARG CATALOGUE_DEPLOYMENT_ENV
ENV CATALOGUE_DEPLOYMENT_ENV=$CATALOGUE_DEPLOYMENT_ENV

ARG CATALOGUE_DOCKER_NETWORK
ENV CATALOGUE_DOCKER_NETWORK=$CATALOGUE_DOCKER_NETWORK

ARG CATALOGUE_LATEST_COMMIT
ENV CATALOGUE_LATEST_COMMIT=$CATALOGUE_LATEST_COMMIT

ARG CATALOGUE_PROXY_ADDRESS
ENV CATALOGUE_PROXY_ADDRESS=$CATALOGUE_PROXY_ADDRESS

ARG ELASTICSEARCH_ADDRESS
ENV ELASTICSEARCH_ADDRESS=$ELASTICSEARCH_ADDRESS

ARG CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES
ENV CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES=$CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES

ARG MONGO_DB_ADDRESS
ENV MONGO_DB_ADDRESS=$MONGO_DB_ADDRESS

ARG MONGO_DB_PASSWORD
ENV MONGO_DB_PASSWORD=$MONGO_DB_PASSWORD

ARG MONGO_DB_USERNAME
ENV MONGO_DB_USERNAME=$MONGO_DB_USERNAME

ARG ODP_ADDRESS
ENV ODP_ADDRESS=$ODP_ADDRESS

ARG POSTGIS_HOST
ENV POSTGIS_HOST=$POSTGIS_HOST

ARG POSTGIS_PASSWORD
ENV POSTGIS_PASSWORD=$POSTGIS_PASSWORD

ARG POSTGIS_DB
ENV POSTGIS_DB=$POSTGIS_DB

ARG POSTGIS_PORT
ENV POSTGIS_PORT=$POSTGIS_PORT

ARG POSTGIS_USERNAME
ENV POSTGIS_USERNAME=$POSTGIS_USERNAME

WORKDIR /app
COPY --from=docker:19.03 /usr/local/bin/docker /usr/local/bin/
COPY . .
RUN npm ci --only=production
EXPOSE 3000

CMD \
  CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES=$CATALOGUE_DEFAULT_ADMIN_EMAIL_ADDRESSES \
  CATALOGUE_API_ALLOWED_ORIGINS=$CATALOGUE_API_ALLOWED_ORIGINS \
  CATALOGUE_API_GOOGLE_CLIENT_ID=$CATALOGUE_API_GOOGLE_CLIENT_ID \
  CATALOGUE_API_GOOGLE_CLIENT_SECRET=$CATALOGUE_API_GOOGLE_CLIENT_SECRET \
  CATALOGUE_API_ADDRESS=$CATALOGUE_API_ADDRESS \
  CATALOGUE_API_NODE_ENV=$CATALOGUE_API_NODE_ENV \
  CATALOGUE_API_OAUTH_REDIRECT_ADDRESS=$CATALOGUE_API_OAUTH_REDIRECT_ADDRESS \
  CATALOGUE_API_ODP_CLIENT_SECRET=$CATALOGUE_API_ODP_CLIENT_SECRET \
  CATALOGUE_API_ODP_FILTER_PATH=$CATALOGUE_API_ODP_FILTER_PATH \
  CATALOGUE_CURATOR_CONTACT=$CATALOGUE_CURATOR_CONTACT \
  CATALOGUE_DEPLOYMENT_ENV=$CATALOGUE_DEPLOYMENT_ENV \
  CATALOGUE_DOCKER_NETWORK=$CATALOGUE_DOCKER_NETWORK \
  CATALOGUE_LATEST_COMMIT=$CATALOGUE_LATEST_COMMIT \
  CATALOGUE_PROXY_ADDRESS=$CATALOGUE_PROXY_ADDRESS \
  ELASTICSEARCH_ADDRESS=$ELASTICSEARCH_ADDRESS \
  MONGO_DB_ADDRESS=$MONGO_DB_ADDRESS \
  MONGO_DB_PASSWORD=$MONGO_DB_PASSWORD \
  MONGO_DB_USERNAME=$MONGO_DB_USERNAME \
  ODP_ADDRESS=$ODP_ADDRESS \
  POSTGIS_DB=$POSTGIS_DB \
  POSTGIS_HOST=$POSTGIS_HOST \
  POSTGIS_PASSWORD=$POSTGIS_PASSWORD \
  POSTGIS_PORT=$POSTGIS_PORT \
  POSTGIS_USERNAME=$POSTGIS_USERNAME \
  npm run start:prod