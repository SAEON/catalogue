FROM node:14.13

ARG MONGO_URL
ENV MONGO_URL=$MONGO_URL

ARG MONGO_USER
ENV MONGO_USER=$MONGO_USER

ARG MONGO_PSWD
ENV MONGO_PSWD=$MONGO_PSWD

ARG POSTGIS_HOST
ENV POSTGIS_HOST=$POSTGIS_HOST

ARG POSTGIS_PORT
ENV POSTGIS_PORT=$POSTGIS_PORT

ARG POSTGIS_USER
ENV POSTGIS_USER=$POSTGIS_USER

ARG POSTGIS_PSWD
ENV POSTGIS_PSWD=$POSTGIS_PSWD

ARG FORCE_PG_RESET
ENV FORCE_PG_RESET=$FORCE_PG_RESET

ARG POSTGIS_FOREIGN_HOST
ENV POSTGIS_FOREIGN_HOST=$POSTGIS_FOREIGN_HOST

ARG POSTGIS_FOREIGN_DBNAME
ENV POSTGIS_FOREIGN_DBNAME=$POSTGIS_FOREIGN_DBNAME

ARG POSTGIS_FOREIGN_USER
ENV POSTGIS_FOREIGN_USER=$POSTGIS_FOREIGN_USER

ARG POSTGIS_FOREIGN_PASSWORD
ENV POSTGIS_FOREIGN_PASSWORD=$POSTGIS_FOREIGN_PASSWORD

ARG ALLOWED_ORIGINS
ENV ALLOWED_ORIGINS=$ALLOWED_ORIGINS

ARG HTTP_PROXY_ADDRESS
ENV HTTP_PROXY_ADDRESS=$HTTP_PROXY_ADDRESS

ARG GQL_PROVIDER
ENV GQL_PROVIDER=$GQL_PROVIDER

ARG ES_HOST_ADDRESS
ENV ES_HOST_ADDRESS=$ES_HOST_ADDRESS

ARG ES_TEMPLATE_INTEGRATION_ENABLED
ENV ES_TEMPLATE_INTEGRATION_ENABLED=$ES_TEMPLATE_INTEGRATION_ENABLED

ARG ES_INDEX_INTEGRATION_ENABLED
ENV ES_INDEX_INTEGRATION_ENABLED=$ES_INDEX_INTEGRATION_ENABLED

ARG LATEST_COMMIT
ENV LATEST_COMMIT=$LATEST_COMMIT

WORKDIR /app
COPY . .
RUN npm ci --only=production
EXPOSE 3000

CMD \
  MONGO_URL=$MONGO_URL \
  MONGO_USER=$MONGO_USER \
  MONGO_PSWD=$MONGO_PSWD \
  POSTGIS_HOST=$POSTGIS_HOST \
  POSTGIS_PORT=$POSTGIS_PORT \
  POSTGIS_USER=$POSTGIS_USER \
  POSTGIS_PSWD=$POSTGIS_PSWD \
  FORCE_PG_RESET=$FORCE_PG_RESET \
  POSTGIS_FOREIGN_HOST=$POSTGIS_FOREIGN_HOST \
  POSTGIS_FOREIGN_DBNAME=$POSTGIS_FOREIGN_DBNAME \
  POSTGIS_FOREIGN_USER=$POSTGIS_FOREIGN_USER \
  POSTGIS_FOREIGN_PASSWORD=$POSTGIS_FOREIGN_PASSWORD \
  ALLOWED_ORIGINS=$ALLOWED_ORIGINS \
  HTTP_PROXY_ADDRESS=$HTTP_PROXY_ADDRESS \
  GQL_PROVIDER=$GQL_PROVIDER \
  ES_HOST_ADDRESS=$ES_HOST_ADDRESS \
  ES_TEMPLATE_INTEGRATION_ENABLED=$ES_TEMPLATE_INTEGRATION_ENABLED \
  ES_INDEX_INTEGRATION_ENABLED=$ES_INDEX_INTEGRATION_ENABLED \
  LATEST_COMMIT=$LATEST_COMMIT \
  npm run start:prod